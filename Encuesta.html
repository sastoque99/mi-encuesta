<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Actividades y Habilidades Digitales</title>
    
    <!-- Tailwind CSS para un diseño moderno y adaptable -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos profesionales -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase (Versión compatible que funciona sin servidor local) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body {
            background-color: #f0f2f5;
            font-family: sans-serif;
        }
        .survey-label {
            display: block;
            padding: 1.25rem;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 1.25rem;
            line-height: 1.75rem;
        }
        .survey-label:hover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        input[type="checkbox"]:checked + .survey-label {
            border-color: #4f46e5;
            background-color: #e0e7ff;
            color: #312e81;
            font-weight: 600;
        }
        input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            width: 2rem;
            height: 2rem;
            padding: 6px;
            background-clip: content-box;
            border: 2px solid #d1d5db;
            background-color: #fff;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="radio"]:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .question-title {
            font-size: 1.75rem;
            line-height: 2.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .question-subtitle {
            font-size: 1.125rem;
            line-height: 1.75rem;
            color: #4b5563;
            margin-bottom: 1.5rem;
        }
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }
        .matrix-table th, .matrix-table td {
            padding: 1rem;
            font-size: 1.1rem;
            vertical-align: middle;
        }
        .matrix-table th {
            background-color: #f3f4f6;
        }
        .matrix-table td:first-child {
            text-align: left;
            font-weight: 600;
        }
        .matrix-table tr:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }
        .has-error {
            border: 2px solid #ef4444;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: #fee2e2;
        }
    </style>

</head>
<body class="text-gray-900">

    <!-- Indicador de Carga -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white"></div>
    </div>

    <!-- Modal de Validación -->
    <div id="validation-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white max-w-lg w-full rounded-2xl shadow-xl p-8">
            <h3 class="text-3xl font-bold text-red-600 mb-4">Faltan respuestas</h3>
            <p class="text-xl text-gray-700 mb-6">Por favor, completa las siguientes preguntas antes de enviar:</p>
            <ul id="validation-errors" class="list-disc list-inside text-lg text-gray-600 space-y-2"></ul>
            <button id="close-validation-modal" class="mt-8 w-full bg-red-600 text-white font-bold rounded-lg text-xl py-3">Entendido</button>
        </div>
    </div>

    <!-- Modal de Reseteo -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white max-w-lg w-full rounded-2xl shadow-xl p-8">
            <h3 class="text-3xl font-bold text-yellow-600 mb-4">¡Atención!</h3>
            <p class="text-xl text-gray-700 mb-6">Esta acción borrará permanentemente TODAS las respuestas de la encuesta. No se puede deshacer. ¿Estás segura de que quieres continuar?</p>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancel-reset" class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-lg text-lg">Cancelar</button>
                <button id="confirm-reset" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg text-lg">Sí, borrar todo</button>
            </div>
        </div>
    </div>


    <!-- Vista de Login (para el admin) -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
            <h2 class="text-4xl font-bold text-center mb-8">Acceso de Administrador</h2>
            <form id="login-form">
                <div class="mb-6">
                    <label for="email" class="block mb-2 text-xl font-medium">Email</label>
                    <input type="email" id="email" name="email" class="bg-gray-100 border-2 border-gray-300 text-xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4" placeholder="tu@email.com" required>
                </div>
                <div class="mb-6 relative">
                    <label for="password" class="block mb-2 text-xl font-medium">Contraseña</label>
                    <input type="password" id="password" name="password" class="bg-gray-100 border-2 border-gray-300 text-xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4 pr-12" required>
                    <span id="togglePassword" class="absolute inset-y-0 right-0 flex items-center pr-4 cursor-pointer" style="top: 3.25rem;">
                        <svg class="h-6 w-6 text-gray-600 eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639l4.443-5.328a1.012 1.012 0 011.59-.057l.542.542a1.012 1.012 0 001.59 0l.542-.542a1.012 1.012 0 011.59 0l.542.542a1.012 1.012 0 001.59 0l.542-.542a1.012 1.012 0 011.59 0l4.443 5.328a1.012 1.012 0 010 .639l-4.443 5.328a1.012 1.012 0 01-1.59.057l-.542-.542a1.012 1.012 0 00-1.59 0l-.542.542a1.012 1.012 0 01-1.59 0l-.542-.542a1.012 1.012 0 00-1.59 0l-.542.542a1.012 1.012 0 01-1.59-.057L2.036 12.322z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <svg class="h-6 w-6 text-gray-600 eye-closed hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A1.012 1.012 0 0112 4.5c4.756 0 8.774 3.162 10.065 7.498a1.012 1.012 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" />
                        </svg>
                    </span>
                </div>
                <p id="login-error" class="hidden text-red-500 text-center mb-4 text-lg">Email o contraseña incorrectos.</p>
                <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-bold rounded-lg text-2xl px-5 py-4 text-center">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- Vista de la Encuesta (pública) -->
    <div id="survey-view" class="container mx-auto p-4 sm:p-8 max-w-4xl">
        <div class="bg-white p-8 sm:p-12 rounded-2xl shadow-lg">
            <h1 class="text-5xl font-extrabold text-center mb-4 text-indigo-700">Encuesta de Actividades</h1>
            <p class="text-2xl text-center text-gray-600 mb-12">Tu participación es muy valiosa. Por favor, responde con la mayor sinceridad posible.</p>

            <form id="survey-form" novalidate>
                <!-- Nombre -->
                <div class="mb-12" id="question-0">
                    <label for="nombre" class="question-title">Tu Nombre</label>
                    <p class="question-subtitle">Este nombre se usará para identificar tus respuestas en el análisis privado.</p>
                    <input type="text" id="nombre" name="nombre" class="bg-gray-100 border-2 border-gray-300 text-2xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4">
                </div>

                <!-- Pregunta 1 -->
                <div class="mb-12" id="question-1">
                    <h2 class="question-title">1. ¿En qué tipo de actividades inviertes más del 50% de tu tiempo?</h2>
                    <p class="question-subtitle">Puedes seleccionar múltiples respuestas.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <script>
                            const p1_options = ["Revisión de literatura académica", "Generación de informes", "Análisis de datos cuantitativos", "Coordinación de eventos", "Tareas administrativas", "Enseñanza y preparación de clases", "Gestión de emails", "Atención a estudiantes", "Revisión de documentos administrativos", "Asistencia a reuniones", "Preparación de presentaciones"];
                            p1_options.forEach(opt => { document.write(`<div><input type="checkbox" id="p1_${opt.replace(/\s+/g, '')}" name="pregunta1" value="${opt}"><label for="p1_${opt.replace(/\s+/g, '')}" class="survey-label">${opt}</label></div>`); });
                        </script>
                    </div>
                    <input type="text" name="pregunta1_otros" placeholder="OTROS. Mencione cuáles por favor" class="mt-4 bg-gray-100 border-2 border-gray-300 text-xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4">
                </div>

                <!-- Pregunta 2 -->
                <div class="mb-12" id="question-2">
                    <h2 class="question-title">2. Selecciona la categoría que mejor define las actividades que realizas en tu rol.</h2>
                    <p class="question-subtitle">Selecciona máximo 2 categorías.</p>
                    <div class="grid grid-cols-1 gap-4">
                         <script>
                            const p2_options = ["Creación y Gestión de Contenido Escrito (Informes, artículos, correos, lectura)", "Producción y Edición Multimedia (Imágenes, videos, audio, presentaciones)", "Análisis de Datos y Métricas (Estadísticas, presupuestos, indicadores)", "Desarrollo Técnico y Programación (Apps, web, automatización con código)", "Gestión, Planificación y Comunicación (Proyectos, eventos, reuniones)"];
                            p2_options.forEach(opt => { document.write(`<div><input type="checkbox" id="p2_${opt.replace(/\s+/g, '').substring(0,10)}" name="pregunta2" value="${opt}"><label for="p2_${opt.replace(/\s+/g, '').substring(0,10)}" class="survey-label">${opt}</label></div>`); });
                        </script>
                    </div>
                     <input type="text" name="pregunta2_otros" placeholder="OTROS. Mencione cuáles por favor" class="mt-4 bg-gray-100 border-2 border-gray-300 text-xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4">
                </div>

                <!-- Pregunta 3 -->
                <div class="mb-12" id="question-3">
                    <h2 class="question-title">3. Indica con qué frecuencia colaboras con estas personas/departamentos en un mes típico de trabajo.</h2>
                    <p class="question-subtitle">Escoge una de las tres opciones para cada fila.</p>
                    <div class="overflow-x-auto">
                        <table class="matrix-table">
                            <thead><tr><th></th><th>Nunca</th><th>Algunas veces</th><th>Constantemente</th></tr></thead>
                            <tbody>
                                <script>
                                    const p3_items = { "Internos Universidad": ["Estudiantes", "Profesores", "Administrativos", "Decanos", "Egresados"], "Externos": ["Otras universidades", "Empresas", "Gobierno"] };
                                    for (const [category, items] of Object.entries(p3_items)) {
                                        document.write(`<tr><td colspan="4" class="bg-indigo-100 text-indigo-800 font-bold text-left text-xl py-3">${category}</td></tr>`);
                                        items.forEach(item => { document.write(`<tr><td>${item}</td><td><input type="radio" data-group="pregunta3" name="p3_${item.replace(/\s+/g, '')}" value="Nunca"></td><td><input type="radio" data-group="pregunta3" name="p3_${item.replace(/\s+/g, '')}" value="Algunas veces"></td><td><input type="radio" data-group="pregunta3" name="p3_${item.replace(/\s+/g, '')}" value="Constantemente"></td></tr>`); });
                                    }
                                </script>
                            </tbody>
                        </table>
                    </div>
                    <input type="text" name="pregunta3_otros" placeholder="OTROS. Mencione cuáles por favor" class="mt-4 bg-gray-100 border-2 border-gray-300 text-xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4">
                </div>

                <!-- Pregunta 4 -->
                <div class="mb-12" id="question-4">
                     <h2 class="question-title">4. En una semana típica de trabajo, ¿cuáles son las herramientas que utilizas en tu rol?</h2>
                    <p class="question-subtitle">Escoge una opción para cada herramienta.</p>
                     <div class="overflow-x-auto">
                        <table class="matrix-table">
                            <thead><tr><th></th><th>No la utilizo</th><th>Algunas veces</th><th>La utilizo constantemente</th></tr></thead>
                            <tbody>
                                <script>
                                    const p4_items = { "IA Generativa": ["ChatGPT", "Claude", "Gemini", "Copilot", "Perplexity", "Deepseek", "Agentes IA (Gemas; GPT)"], "Análisis de datos": ["Excel", "Power BI"], "Ofimática y Colaboración": ["Word", "PowerPoint", "Gestores de Proyectos (Asana, Trello)"], "Diseño": ["Canva", "Gamma"] };
                                    for (const [category, items] of Object.entries(p4_items)) {
                                        document.write(`<tr><td colspan="4" class="bg-indigo-100 text-indigo-800 font-bold text-left text-xl py-3">${category}</td></tr>`);
                                        items.forEach(item => { document.write(`<tr><td>${item}</td><td><input type="radio" data-group="pregunta4" name="p4_${item.replace(/\s+/g, '')}" value="No la utilizo"></td><td><input type="radio" data-group="pregunta4" name="p4_${item.replace(/\s+/g, '')}" value="Algunas veces"></td><td><input type="radio" data-group="pregunta4" name="p4_${item.replace(/\s+/g, '')}" value="La utilizo constantemente"></td></tr>`); });
                                    }
                                </script>
                            </tbody>
                        </table>
                    </div>
                    <input type="text" name="pregunta4_otros" placeholder="OTROS. Mencione cuáles por favor" class="mt-4 bg-gray-100 border-2 border-gray-300 text-xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4">
                </div>

                <!-- Pregunta 5 -->
                 <div class="mb-12" id="question-5">
                     <h2 class="question-title">5. ¿Qué tipo de actividades te gustaría potenciar con el uso de habilidades digitales?</h2>
                    <p class="question-subtitle">Escoge una opción para cada actividad.</p>
                     <div class="overflow-x-auto">
                        <table class="matrix-table">
                            <thead><tr><th></th><th>Prioritario</th><th>Puede esperar</th><th>No lo necesito</th></tr></thead>
                            <tbody>
                                <script>
                                    const p5_items = ["Generación de informes", "Seguimiento de correos", "Análisis de grandes volúmenes de datos", "Creación de presentaciones", "Diseño gráfico básico", "Generación de videos", "Crear contenido educativo", "Gestión de proyectos"];
                                    p5_items.forEach(item => { document.write(`<tr><td>${item}</td><td><input type="radio" data-group="pregunta5" name="p5_${item.replace(/\s+/g, '')}" value="Prioritario"></td><td><input type="radio" data-group="pregunta5" name="p5_${item.replace(/\s+/g, '')}" value="Puede esperar"></td><td><input type="radio" data-group="pregunta5" name="p5_${item.replace(/\s+/g, '')}" value="No lo necesito"></td></tr>`); });
                                </script>
                            </tbody>
                        </table>
                    </div>
                    <input type="text" name="pregunta5_otros" placeholder="OTROS. Mencione cuáles por favor" class="mt-4 bg-gray-100 border-2 border-gray-300 text-xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4">
                </div>

                <!-- Pregunta 6 -->
                <div class="mb-12" id="question-6">
                    <h2 class="question-title">6. Según tu experiencia, ¿qué objetivo consideras que es clave priorizar desde el proceso de Investigación de la Universidad?</h2>
                    <textarea name="pregunta6" rows="5" class="bg-gray-100 border-2 border-gray-300 text-2xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4"></textarea>
                </div>

                <!-- Pregunta 7 -->
                 <div class="mb-12" id="question-7">
                    <h2 class="question-title">7. Pensando en tus fortalezas, ¿qué aporte te gustaría desarrollar o fortalecer desde tu rol en el proceso de Investigación de la Universidad?</h2>
                    <textarea name="pregunta7" rows="5" class="bg-gray-100 border-2 border-gray-300 text-2xl rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4"></textarea>
                </div>

                <!-- Botón de envío -->
                <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-bold rounded-lg text-3xl px-5 py-6 text-center mt-8">Enviar mis respuestas</button>
            </form>
        </div>
    </div>

    <!-- Vista de Agradecimiento -->
    <div id="thank-you-view" class="hidden min-h-screen flex items-center justify-center text-center">
        <div class="bg-white p-12 rounded-2xl shadow-lg">
            <h1 class="text-6xl font-bold text-green-500 mb-4">¡Gracias!</h1>
            <p class="text-3xl text-gray-700">Tus respuestas han sido enviadas correctamente.</p>
            <p class="mt-8 text-xl">
                <a href="#admin" id="go-to-admin" class="text-indigo-600 hover:underline font-semibold">¿Eres el administrador? Haz clic aquí para ver los resultados.</a>
            </p>
        </div>
    </div>

    <!-- Vista de Administrador (privada) -->
    <div id="admin-view" class="hidden container mx-auto p-4 sm:p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-5xl font-bold">Panel de Resultados</h1>
            <div>
                <button id="export-csv-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-xl mr-4">Exportar a CSV</button>
                <button id="reset-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg text-xl mr-4">Resetear Respuestas</button>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-xl">Cerrar Sesión</button>
            </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 text-center">
            <h2 class="text-3xl font-bold">Total de Respuestas Recibidas: <span id="response-count" class="text-indigo-600">0</span></h2>
        </div>
        
        <div id="results-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Los gráficos consolidados se insertarán aquí -->
        </div>
        
        <h2 class="text-4xl font-bold mt-12 mb-6">Registro de Respuestas</h2>
        <div class="bg-white p-6 rounded-2xl shadow-lg w-full overflow-x-auto">
            <table id="responses-table" class="w-full text-left">
                <thead>
                    <tr class="border-b-2 border-gray-200">
                        <th class="p-4 text-xl">Nombre del Participante</th>
                        <th class="p-4 text-xl">Fecha de Respuesta</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas de la tabla se insertarán aquí -->
                </tbody>
            </table>
        </div>

        <h2 class="text-4xl font-bold mt-12 mb-6">Análisis Individual</h2>
        <div class="bg-white p-6 rounded-2xl shadow-lg w-full">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Ver Respuestas por Usuario</h3>
            <select id="user-selector" class="w-full p-3 border border-gray-300 rounded-lg text-xl mb-4">
                <option value="">-- Seleccione un usuario --</option>
            </select>
            <div id="single-user-results-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-4">
                <!-- Los gráficos individuales se mostrarán aquí -->
            </div>
             <div id="single-user-open-questions" class="space-y-6 mt-6">
                <!-- Las respuestas abiertas individuales se mostrarán aquí -->
            </div>
        </div>
    </div>

    <script>
        // ===================================================================================
        // LÓGICA DE LA APLICACIÓN
        // ===================================================================================
        try {
            // CONFIGURACIÓN DE FIREBASE
            const firebaseConfig = {
              apiKey: "AIzaSyAQWss09x9EsbPCaWrWTwcxVtQcnj3LVUw",
              authDomain: "encuestaucmc.firebaseapp.com",
              projectId: "encuestaucmc",
              storageBucket: "encuestaucmc.firebasestorage.app",
              messagingSenderId: "280228494415",
              appId: "1:280228494415:web:9014c67c5d2a1a8a74fe3a",
              measurementId: "G-CHZWTF2C5P"
            };

            // Inicializar Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Referencia a la colección de respuestas
            const responsesCollection = db.collection("surveyResponses");
            let allResponses = []; // Variable para guardar todas las respuestas
            let individualCharts = {}; // Para gestionar los gráficos individuales

            // Elementos de la interfaz
            const loginView = document.getElementById('login-view');
            const surveyView = document.getElementById('survey-view');
            const adminView = document.getElementById('admin-view');
            const thankYouView = document.getElementById('thank-you-view');
            const loadingIndicator = document.getElementById('loading');
            const validationModal = document.getElementById('validation-modal');
            const validationErrors = document.getElementById('validation-errors');
            const closeValidationModal = document.getElementById('close-validation-modal');
            const resetModal = document.getElementById('reset-modal');
            const confirmResetBtn = document.getElementById('confirm-reset');
            const cancelResetBtn = document.getElementById('cancel-reset');

            function showView(view) {
                [loginView, surveyView, adminView, thankYouView].forEach(v => v.classList.add('hidden'));
                view.classList.remove('hidden');
            }

            const loginForm = document.getElementById('login-form');
            const passwordInput = document.getElementById('password');
            const togglePassword = document.getElementById('togglePassword');

            togglePassword.addEventListener('click', function () {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.querySelector('svg.eye-open').classList.toggle('hidden');
                this.querySelector('svg.eye-closed').classList.toggle('hidden');
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = loginForm.email.value;
                const password = passwordInput.value;
                loadingIndicator.classList.remove('hidden');
                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => {
                        console.error("Error al iniciar sesión:", error.code, error.message);
                        document.getElementById('login-error').classList.remove('hidden');
                    })
                    .finally(() => {
                        loadingIndicator.classList.add('hidden');
                    });
            });

            document.getElementById('logout-button').addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.hash = '';
                    window.location.reload();
                });
            });

            auth.onAuthStateChanged((user) => {
                if (user) {
                    showView(adminView);
                    loadResults();
                } else {
                    if (window.location.hash === '#admin') {
                        showView(loginView);
                    } else {
                        showView(surveyView);
                    }
                }
            });

            const surveyForm = document.getElementById('survey-form');

            function validateForm() {
                const errors = [];
                document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));
                if (surveyForm.nombre.value.trim() === '') {
                    errors.push("Por favor, ingresa tu nombre.");
                    surveyForm.nombre.parentElement.classList.add('has-error');
                }
                if (surveyForm.querySelectorAll('input[name="pregunta1"]:checked').length === 0) {
                    errors.push("Por favor, responde la Pregunta 1.");
                    document.getElementById('question-1').classList.add('has-error');
                }
                if (surveyForm.querySelectorAll('input[name="pregunta2"]:checked').length === 0) {
                    errors.push("Por favor, responde la Pregunta 2.");
                    document.getElementById('question-2').classList.add('has-error');
                }
                ['pregunta3', 'pregunta4', 'pregunta5'].forEach((groupName, index) => {
                    const groupContainer = document.getElementById(`question-${index + 3}`);
                    const radioButtons = groupContainer.querySelectorAll(`input[data-group="${groupName}"]`);
                    const questionsInGroup = new Set([...radioButtons].map(rb => rb.name));
                    const answeredInGroup = new Set([...groupContainer.querySelectorAll(`input[data-group="${groupName}"]:checked`)].map(rb => rb.name));
                    if (answeredInGroup.size < questionsInGroup.size) {
                        errors.push(`Por favor, completa todas las filas de la Pregunta ${index + 3}.`);
                        groupContainer.classList.add('has-error');
                    }
                });
                if (surveyForm.pregunta6.value.trim() === '') {
                    errors.push("Por favor, responde la Pregunta 6.");
                    surveyForm.pregunta6.parentElement.classList.add('has-error');
                }
                if (surveyForm.pregunta7.value.trim() === '') {
                    errors.push("Por favor, responde la Pregunta 7.");
                    surveyForm.pregunta7.parentElement.classList.add('has-error');
                }
                if (errors.length > 0) {
                    validationErrors.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
                    validationModal.classList.remove('hidden');
                    return false;
                }
                return true;
            }

            closeValidationModal.addEventListener('click', () => validationModal.classList.add('hidden'));

            surveyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateForm()) return;

                loadingIndicator.classList.remove('hidden');
                const formData = new FormData(surveyForm);
                const response = {
                    nombre: formData.get('nombre'),
                    pregunta1: formData.getAll('pregunta1'),
                    pregunta1_otros: formData.get('pregunta1_otros'),
                    pregunta2: formData.getAll('pregunta2'),
                    pregunta2_otros: formData.get('pregunta2_otros'),
                    pregunta3: {},
                    pregunta3_otros: formData.get('pregunta3_otros'),
                    pregunta4: {},
                    pregunta4_otros: formData.get('pregunta4_otros'),
                    pregunta5: {},
                    pregunta5_otros: formData.get('pregunta5_otros'),
                    pregunta6: formData.get('pregunta6'),
                    pregunta7: formData.get('pregunta7'),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                document.querySelectorAll('[data-group="pregunta3"]:checked').forEach(el => response.pregunta3[el.name] = el.value);
                document.querySelectorAll('[data-group="pregunta4"]:checked').forEach(el => response.pregunta4[el.name] = el.value);
                document.querySelectorAll('[data-group="pregunta5"]:checked').forEach(el => response.pregunta5[el.name] = el.value);

                responsesCollection.add(response)
                    .then(() => showView(thankYouView))
                    .catch((error) => {
                        console.error("Error al guardar la respuesta: ", error);
                        alert("Hubo un error al enviar tu respuesta.");
                    })
                    .finally(() => loadingIndicator.classList.add('hidden'));
            });
            
            document.querySelectorAll('input[name="pregunta2"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (document.querySelectorAll('input[name="pregunta2"]:checked').length > 2) {
                        alert('Puedes seleccionar un máximo de 2 categorías.');
                        checkbox.checked = false;
                    }
                });
            });

            let charts = {}; 

            function loadResults() {
                loadingIndicator.classList.remove('hidden');
                responsesCollection.orderBy("timestamp", "desc").get().then((querySnapshot) => {
                    allResponses = [];
                    querySnapshot.forEach((doc) => allResponses.push({id: doc.id, ...doc.data()}));
                    document.getElementById('response-count').textContent = allResponses.length;
                    
                    const individualContainer = document.getElementById('single-user-results-container');
                    const openContainer = document.getElementById('single-user-open-questions');

                    if (allResponses.length > 0) {
                        generateCharts(allResponses);
                        populateUserSelector(allResponses);
                        populateResponseTable(allResponses);
                    } else {
                        document.getElementById('results-container').innerHTML = '<p class="text-center text-gray-500 text-2xl">Aún no hay respuestas.</p>';
                        document.getElementById('responses-table').querySelector('tbody').innerHTML = '';
                        populateUserSelector([]);
                        individualContainer.innerHTML = ''; // Limpiar gráficos individuales
                        openContainer.innerHTML = ''; // Limpiar textos individuales
                    }
                }).catch((error) => {
                    console.error("Error al cargar los resultados: ", error);
                }).finally(() => loadingIndicator.classList.add('hidden'));
            }

            function generateCharts(data) {
                const resultsContainer = document.getElementById('results-container');
                resultsContainer.innerHTML = '';
                Object.values(charts).forEach(chart => chart.destroy());
                charts = {};

                const p1Data = data.flatMap(r => r.pregunta1).reduce((acc, curr) => ({...acc, [curr]: (acc[curr] || 0) + 1 }), {});
                charts.p1 = createChart(resultsContainer, 'pregunta1-chart', '1. Actividades > 50% tiempo', 'bar', p1Data);

                const p2Data = data.flatMap(r => r.pregunta2).reduce((acc, curr) => ({...acc, [curr]: (acc[curr] || 0) + 1 }), {});
                charts.p2 = createChart(resultsContainer, 'pregunta2-chart', '2. Categoría de actividades', 'pie', p2Data);
                
                const p3Data = { 'Nunca': 0, 'Algunas veces': 0, 'Constantemente': 0 };
                data.forEach(r => Object.values(r.pregunta3).forEach(val => { if (p3Data[val] !== undefined) p3Data[val]++; }));
                charts.p3 = createChart(resultsContainer, 'pregunta3-chart', '3. Frecuencia de colaboración', 'bar', p3Data);

                const p4Data = { 'No la utilizo': 0, 'Algunas veces': 0, 'La utilizo constantemente': 0 };
                data.forEach(r => Object.values(r.pregunta4).forEach(val => { if (p4Data[val] !== undefined) p4Data[val]++; }));
                charts.p4 = createChart(resultsContainer, 'pregunta4-chart', '4. Frecuencia de uso de herramientas', 'doughnut', p4Data);

                const p5Data = { 'Prioritario': 0, 'Puede esperar': 0, 'No lo necesito': 0 };
                data.forEach(r => Object.values(r.pregunta5).forEach(val => { if (p5Data[val] !== undefined) p5Data[val]++; }));
                charts.p5 = createChart(resultsContainer, 'pregunta5-chart', '5. Actividades a potenciar', 'bar', p5Data);
            }
            
            function createChart(container, canvasId, title, type, data) {
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'bg-white p-6 rounded-2xl shadow-lg w-full relative h-96';
                const canvas = document.createElement('canvas');
                canvas.id = canvasId;
                chartWrapper.appendChild(canvas);
                container.appendChild(chartWrapper);

                return new Chart(canvas.getContext('2d'), {
                    type: type,
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            label: 'Número de respuestas',
                            data: Object.values(data),
                            backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)', 'rgba(199, 199, 199, 0.6)', 'rgba(83, 102, 255, 0.6)', 'rgba(4, 217, 255, 0.6)', 'rgba(255, 64, 129, 0.6)'],
                            borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(199, 199, 199, 1)', 'rgba(83, 102, 255, 1)', 'rgba(4, 217, 255, 1)', 'rgba(255, 64, 129, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: title, font: { size: 22, family: 'sans-serif' }, padding: { top: 10, bottom: 30 } },
                            legend: { display: type === 'pie' || type === 'doughnut', position: 'top' }
                        },
                        scales: { y: { beginAtZero: true, display: type === 'bar' || type === 'line' } }
                    }
                });
            }
            
            function populateUserSelector(data) {
                const selector = document.getElementById('user-selector');
                selector.innerHTML = '<option value="">-- Seleccione un usuario --</option>'; // Reset
                const userNames = [...new Set(data.map(r => r.nombre))];
                userNames.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selector.appendChild(option);
                });
            }

            function populateResponseTable(data) {
                const tableBody = document.getElementById('responses-table').querySelector('tbody');
                tableBody.innerHTML = '';
                data.forEach(r => {
                    const row = tableBody.insertRow();
                    const cellName = row.insertCell();
                    const cellDate = row.insertCell();
                    cellName.textContent = r.nombre;
                    cellName.className = 'p-4';
                    cellDate.textContent = r.timestamp ? r.timestamp.toDate().toLocaleString('es-ES') : 'No disponible';
                    cellDate.className = 'p-4';
                });
            }

            document.getElementById('user-selector').addEventListener('change', (e) => {
                const selectedName = e.target.value;
                Object.values(individualCharts).forEach(chart => chart.destroy());
                individualCharts = {};
                const container = document.getElementById('single-user-results-container');
                const openContainer = document.getElementById('single-user-open-questions');
                container.innerHTML = '';
                openContainer.innerHTML = '';
                if (selectedName) {
                    const userData = allResponses.find(r => r.nombre === selectedName);
                    if (userData) {
                        displaySingleUserCharts(userData);
                    }
                }
            });

            function displaySingleUserCharts(data) {
                const container = document.getElementById('single-user-results-container');
                const openContainer = document.getElementById('single-user-open-questions');

                // P1
                const p1Data = {};
                data.pregunta1.forEach(item => p1Data[item] = 1);
                individualCharts.p1 = createChart(container, 'user-p1-chart', '1. Actividades > 50% tiempo', 'bar', p1Data);

                // P2
                const p2Data = {};
                data.pregunta2.forEach(item => p2Data[item] = 1);
                individualCharts.p2 = createChart(container, 'user-p2-chart', '2. Categoría de actividades', 'bar', p2Data);

                // P3 - Radar Chart
                const p3Labels = Object.keys(data.pregunta3).map(k => k.replace(/p3_/g, '').replace(/([A-Z])/g, ' $1').trim());
                const p3Values = Object.values(data.pregunta3).map(v => (v === 'Nunca' ? 1 : v === 'Algunas veces' ? 2 : 3));
                individualCharts.p3 = createRadarChart(container, 'user-p3-chart', '3. Frecuencia de colaboración', p3Labels, p3Values);
                
                // P4 - Radar Chart
                const p4Labels = Object.keys(data.pregunta4).map(k => k.replace(/p4_/g, '').replace(/([A-Z])/g, ' $1').trim());
                const p4Values = Object.values(data.pregunta4).map(v => (v === 'No la utilizo' ? 1 : v === 'Algunas veces' ? 2 : 3));
                individualCharts.p4 = createRadarChart(container, 'user-p4-chart', '4. Frecuencia de uso de herramientas', p4Labels, p4Values);

                // P5 - Radar Chart
                const p5Labels = Object.keys(data.pregunta5).map(k => k.replace(/p5_/g, '').replace(/([A-Z])/g, ' $1').trim());
                const p5Values = Object.values(data.pregunta5).map(v => (v === 'No lo necesito' ? 1 : v === 'Puede esperar' ? 2 : 3));
                individualCharts.p5 = createRadarChart(container, 'user-p5-chart', '5. Actividades a potenciar', p5Labels, p5Values);

                // Open questions
                appendSingleResult(openContainer, '6. Objetivo clave a priorizar', data.pregunta6);
                appendSingleResult(openContainer, '7. Aporte a desarrollar', data.pregunta7);
                if(data.pregunta1_otros) appendSingleResult(openContainer, 'P1 OTROS', data.pregunta1_otros);
                if(data.pregunta2_otros) appendSingleResult(openContainer, 'P2 OTROS', data.pregunta2_otros);
                if(data.pregunta3_otros) appendSingleResult(openContainer, 'P3 OTROS', data.pregunta3_otros);
                if(data.pregunta4_otros) appendSingleResult(openContainer, 'P4 OTROS', data.pregunta4_otros);
                if(data.pregunta5_otros) appendSingleResult(openContainer, 'P5 OTROS', data.pregunta5_otros);
            }
            
            function createRadarChart(container, canvasId, title, labels, dataValues) {
                 const chartWrapper = document.createElement('div');
                chartWrapper.className = 'bg-white p-6 rounded-2xl shadow-lg w-full relative h-96';
                const canvas = document.createElement('canvas');
                canvas.id = canvasId;
                chartWrapper.appendChild(canvas);
                container.appendChild(chartWrapper);

                return new Chart(canvas.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Respuesta',
                            data: dataValues,
                            fill: true,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgb(54, 162, 235)',
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(54, 162, 235)'
                        }]
                    },
                    options: {
                       responsive: true,
                       maintainAspectRatio: false,
                       plugins: {
                            title: { display: true, text: title, font: { size: 22, family: 'sans-serif' }, padding: { top: 10, bottom: 30 } },
                       },
                       scales: {
                            r: {
                                beginAtZero: true,
                                max: 3,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (title.includes('colaboración') || title.includes('herramientas')) {
                                            return ['', 'Baja', 'Media', 'Alta'][value];
                                        }
                                        return ['', 'No necesito', 'Puede esperar', 'Prioritario'][value];
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function appendSingleResult(container, title, content) {
                if (!content || content.length === 0) return;
                const resultDiv = document.createElement('div');
                resultDiv.className = 'bg-white p-6 rounded-2xl shadow-lg w-full';
                const pTitle = document.createElement('h3');
                pTitle.className = 'text-2xl font-bold mb-4 text-gray-800';
                pTitle.textContent = title;
                const pContent = document.createElement('p');
                pContent.className = 'text-gray-700 text-lg mt-1';
                pContent.innerHTML = content;
                resultDiv.appendChild(pTitle);
                resultDiv.appendChild(pContent);
                container.appendChild(resultDiv);
            }

            document.getElementById('reset-button').addEventListener('click', () => {
                resetModal.classList.remove('hidden');
            });
            cancelResetBtn.addEventListener('click', () => {
                resetModal.classList.add('hidden');
            });
            confirmResetBtn.addEventListener('click', () => {
                resetModal.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                const deletePromises = allResponses.map(resp => responsesCollection.doc(resp.id).delete());
                Promise.all(deletePromises).then(() => {
                    console.log("Todas las respuestas han sido borradas.");
                    loadResults(); // Recargar los resultados (ahora vacíos)
                }).catch(error => {
                    console.error("Error al borrar las respuestas: ", error);
                }).finally(() => {
                    loadingIndicator.classList.add('hidden');
                });
            });

            document.getElementById('go-to-admin').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = 'admin';
                window.location.reload();
            });

            document.getElementById('export-csv-button').addEventListener('click', () => {
                if (allResponses.length === 0) {
                    alert("No hay respuestas para exportar.");
                    return;
                }

                const headers = [ "Nombre", "Fecha", "P1: Actividades", "P1: Otros", "P2: Categorías", "P2: Otros", "P3: Colaboración", "P3: Otros", "P4: Herramientas", "P4: Otros", "P5: Habilidades a potenciar", "P5: Otros", "P6: Objetivo clave", "P7: Aporte a desarrollar" ];
                
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";

                allResponses.forEach(r => {
                    const row = [
                        `"${r.nombre}"`,
                        `"${r.timestamp ? r.timestamp.toDate().toLocaleString('es-ES') : ''}"`,
                        `"${r.pregunta1.join('; ')}"`,
                        `"${r.pregunta1_otros || ''}"`,
                        `"${r.pregunta2.join('; ')}"`,
                        `"${r.pregunta2_otros || ''}"`,
                        `"${Object.entries(r.pregunta3).map(([k,v]) => `${k.replace(/p3_/g, '')}:${v}`).join('; ')}"`,
                        `"${r.pregunta3_otros || ''}"`,
                        `"${Object.entries(r.pregunta4).map(([k,v]) => `${k.replace(/p4_/g, '')}:${v}`).join('; ')}"`,
                        `"${r.pregunta4_otros || ''}"`,
                        `"${Object.entries(r.pregunta5).map(([k,v]) => `${k.replace(/p5_/g, '')}:${v}`).join('; ')}"`,
                        `"${r.pregunta5_otros || ''}"`,
                        `"${(r.pregunta6 || '').replace(/"/g, '""')}"`,
                        `"${(r.pregunta7 || '').replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(",") + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "resultados_encuesta.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

        } catch (error) {
            console.error("Error al inicializar la aplicación:", error);
            document.body.innerHTML = '<div class="text-center p-8"><h1 class="text-2xl text-red-500">Error Crítico</h1><p>No se pudo cargar la aplicación. Revisa la consola para más detalles.</p></div>';
        }
    </script>
</body>
</html>
" code between  and  in the most up-to-date Canvas "Aplicación de Encuesta con Panel de Administrador" document above and am asking a query about/based on this code below.
Instructions to follow:
  * Don't output/edit the document if the query is Direct/Simple. For example, if the query asks for a simple explanation, output a direct answer.
  * Make sure to **edit** the document if the query shows the intent of editing the document, in which case output the entire edited document, **not just that section or the edits**.
    * Don't output the same document/empty document and say that you have edited it.
    * Don't change unrelated code in the document.
  * Don't output  and  in your final response.
  * Any references like "this" or "selected code" refers to the code between  and  tags.
  * Just acknowledge my request in the introduction.
  * Make sure to refer to the document as "Canvas" in your response.

por favor puedes revisar porque sigue apareciendo el código en la parte de ab
